---
title: "香港人口变化数据爬取与分析"
author: "COMP2501 Project"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
```

# 项目概述

本项目旨在从香港移民局及相关政府部门网站爬取近年香港人口变化的详细数据，并进行数据分析和可视化。通过分析人口变化趋势，我们可以了解香港的人口动态、移民流动情况以及相关的人口结构变化。

## 研究问题

1.  近年来香港人口总量如何变化？
2.  香港人口的流入和流出情况如何？
3.  人口变化的主要驱动因素是什么？

# 数据来源

本项目的目标数据源包括： - 香港政府统计处（Census and Statistics
Department） - 香港入境事务处（Immigration Department） -
相关政府公报和统计报告

# 加载必要的R包

```{r load-packages}
# 网络爬取相关包
library(rvest)      # 用于HTML解析和网页爬取
library(httr)       # 用于HTTP请求
library(xml2)       # XML/HTML处理

# 数据处理相关包
library(tidyverse)  # 数据整理和可视化
library(dplyr)      # 数据操作
library(readr)      # 数据读取
library(lubridate)  # 日期处理

# 可视化相关包
library(ggplot2)    # 数据可视化
library(plotly)     # 交互式图表

# 其他工具包
library(stringr)    # 字符串处理
library(jsonlite)   # JSON数据处理（如果数据是JSON格式）
```

# 数据爬取

## 方法一：从香港政府统计处网站爬取

```{r scrape-census-stats}
# 定义目标URL（香港政府统计处人口统计页面）
# 注意：实际URL需要根据网站结构调整
census_url <- "https://www.censtatd.gov.hk/tc/scode150.html"

# 尝试访问网页
tryCatch({
  # 设置用户代理，模拟浏览器访问
  user_agent <- "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
  
  # 发送GET请求
  response <- GET(census_url, 
                  user_agent(user_agent),
                  timeout(30))
  
  # 检查响应状态
  if (status_code(response) == 200) {
    cat("成功连接到网站\n")
    
    # 解析HTML内容
    page_content <- read_html(response)
    
    # 提取所有表格
    tables <- page_content %>% html_nodes("table")
    cat("找到", length(tables), "个表格\n")
    
    # 提取所有链接（可能包含数据下载链接）
    links <- page_content %>% 
      html_nodes("a") %>% 
      html_attr("href")
    
    # 过滤出可能包含数据的链接（如PDF、Excel、CSV文件）
    data_links <- links[grepl("\\.(pdf|xlsx|csv|xls)$", links, ignore.case = TRUE)]
    cat("找到", length(data_links), "个可能的数据文件链接\n")
    
  } else {
    cat("无法访问网站，状态码：", status_code(response), "\n")
  }
}, error = function(e) {
  cat("爬取过程中出现错误：", e$message, "\n")
})
```

## 方法二：从入境事务处网站爬取移民数据

```{r scrape-immigration-data}
# 入境事务处相关URL
immigration_url <- "https://www.immd.gov.hk/"

tryCatch({
  # 设置请求头
  headers <- c(
    'User-Agent' = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
    'Accept' = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Accept-Language' = 'zh-CN,zh;q=0.9,en;q=0.8'
  )
  
  # 发送请求
  response <- GET(immigration_url, 
                  add_headers(.headers = headers),
                  timeout(30))
  
  if (status_code(response) == 200) {
    page <- read_html(response)
    
    # 查找包含统计数据的链接
    stat_links <- page %>% 
      html_nodes("a") %>% 
      html_attr("href") %>% 
      .[grepl("statistic|stat|data|population|人口|统计", ., ignore.case = TRUE)]
    
    cat("找到", length(stat_links), "个可能的统计链接\n")
    print(head(stat_links, 10))
  }
}, error = function(e) {
  cat("错误：", e$message, "\n")
})
```

## 方法三：从政府新闻公报爬取人口数据

```{r scrape-gov-news}
# 香港政府新闻处可能发布人口统计公报
gov_news_url <- "https://www.info.gov.hk/gia/general/"

# 搜索包含人口统计的新闻
search_terms <- c("人口", "population", "统计", "census")

# 注意：实际爬取时需要根据网站结构调整选择器
# 这里提供一个框架
```

## 方法四：使用API或直接下载数据文件

```{r download-data-files}
# 如果网站提供直接下载链接，可以使用download.file()
# 示例：下载CSV或Excel文件

# 创建数据存储目录
if (!dir.exists("data")) {
  dir.create("data")
}

# 示例：如果有直接的数据下载链接
# download_url <- "https://example.com/population_data.csv"
# download.file(download_url, destfile = "data/population_data.csv", mode = "wb")
```

# 数据清理与预处理

## 创建示例数据结构

由于实际网站结构可能不同，这里提供一个数据清理的示例框架：

```{r data-cleaning-example}
# 假设我们已经爬取到了原始数据
# 这里创建一个示例数据集用于演示数据清理过程

# 创建示例数据（模拟香港人口数据）
set.seed(123)
years <- 2015:2023
example_data <- data.frame(
  Year = years,
  Total_Population = round(7300000 + runif(length(years), -50000, 100000)),
  Births = round(50000 + runif(length(years), -5000, 5000)),
  Deaths = round(45000 + runif(length(years), -3000, 3000)),
  Immigration = round(60000 + runif(length(years), -10000, 15000)),
  Emigration = round(40000 + runif(length(years), -8000, 12000)),
  stringsAsFactors = FALSE
)

# 计算净移民
example_data <- example_data %>%
  mutate(
    Net_Migration = Immigration - Emigration,
    Natural_Increase = Births - Deaths,
    Population_Change = Net_Migration + Natural_Increase
  )

# 查看清理后的数据
head(example_data)
```

## 数据验证

```{r data-validation}
# 检查数据完整性
cat("数据行数：", nrow(example_data), "\n")
cat("数据列数：", ncol(example_data), "\n")
cat("缺失值数量：", sum(is.na(example_data)), "\n")

# 检查数据类型
str(example_data)

# 基本统计摘要
summary(example_data)
```

# 数据可视化

## 1. 总人口变化趋势

```{r plot-total-population}
ggplot(example_data, aes(x = Year, y = Total_Population)) +
  geom_line(color = "#2c3e50", size = 1.2) +
  geom_point(color = "#e74c3c", size = 3) +
  labs(
    title = "香港总人口变化趋势（2015-2023）",
    subtitle = "数据来源：香港政府统计处",
    x = "年份",
    y = "总人口数",
    caption = "注：数据为示例数据"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12)
  ) +
  scale_y_continuous(labels = scales::comma_format())
```

## 2. 人口流入与流出对比

```{r plot-migration}
# 准备数据用于绘制堆叠图
migration_data <- example_data %>%
  select(Year, Immigration, Emigration) %>%
  pivot_longer(cols = c(Immigration, Emigration),
               names_to = "Type",
               values_to = "Count")

ggplot(migration_data, aes(x = Year, y = Count, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_fill_manual(
    values = c("Immigration" = "#27ae60", "Emigration" = "#e74c3c"),
    labels = c("Immigration" = "移入", "Emigration" = "移出")
  ) +
  labs(
    title = "香港人口移入与移出对比",
    x = "年份",
    y = "人数",
    fill = "类型"
  ) +
  theme_minimal() +
  theme(legend.position = "top")
```

## 3. 净移民变化

```{r plot-net-migration}
ggplot(example_data, aes(x = Year, y = Net_Migration)) +
  geom_col(aes(fill = Net_Migration > 0), alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_fill_manual(
    values = c("TRUE" = "#27ae60", "FALSE" = "#e74c3c"),
    labels = c("TRUE" = "净流入", "FALSE" = "净流出"),
    name = "状态"
  ) +
  labs(
    title = "香港净移民变化",
    x = "年份",
    y = "净移民数",
    caption = "正值表示净流入，负值表示净流出"
  ) +
  theme_minimal()
```

## 4. 人口自然增长与净移民对比

```{r plot-population-components}
# 准备数据
components_data <- example_data %>%
  select(Year, Natural_Increase, Net_Migration) %>%
  pivot_longer(cols = c(Natural_Increase, Net_Migration),
               names_to = "Component",
               values_to = "Change")

ggplot(components_data, aes(x = Year, y = Change, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_fill_manual(
    values = c("Natural_Increase" = "#3498db", "Net_Migration" = "#9b59b6"),
    labels = c("Natural_Increase" = "自然增长", "Net_Migration" = "净移民")
  ) +
  labs(
    title = "香港人口变化组成：自然增长 vs 净移民",
    x = "年份",
    y = "人口变化数",
    fill = "组成部分"
  ) +
  theme_minimal()
```

## 5. 综合趋势图

```{r plot-comprehensive}
# 创建多面板图
p1 <- ggplot(example_data, aes(x = Year)) +
  geom_line(aes(y = Total_Population), color = "#2c3e50", size = 1) +
  labs(title = "总人口", y = "人数") +
  theme_minimal()

p2 <- ggplot(example_data, aes(x = Year, y = Net_Migration)) +
  geom_col(fill = "#3498db", alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "净移民", y = "人数") +
  theme_minimal()

p3 <- ggplot(example_data, aes(x = Year, y = Natural_Increase)) +
  geom_col(fill = "#e74c3c", alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "自然增长", y = "人数") +
  theme_minimal()

# 使用gridExtra包组合图表
library(gridExtra)
grid.arrange(p1, p2, p3, ncol = 1, 
             top = "香港人口变化综合分析")
```

# 数据分析

## 描述性统计

```{r descriptive-stats}
# 计算关键指标
cat("=== 描述性统计 ===\n\n")

cat("总人口统计：\n")
cat("  平均人口：", round(mean(example_data$Total_Population)), "\n")
cat("  最大人口：", max(example_data$Total_Population), "（", 
    example_data$Year[which.max(example_data$Total_Population)], "年）\n")
cat("  最小人口：", min(example_data$Total_Population), "（", 
    example_data$Year[which.min(example_data$Total_Population)], "年）\n")
cat("  人口变化：", 
    example_data$Total_Population[nrow(example_data)] - example_data$Total_Population[1], "\n\n")

cat("净移民统计：\n")
cat("  平均净移民：", round(mean(example_data$Net_Migration)), "\n")
cat("  总净移民：", sum(example_data$Net_Migration), "\n\n")

cat("自然增长统计：\n")
cat("  平均自然增长：", round(mean(example_data$Natural_Increase)), "\n")
cat("  总自然增长：", sum(example_data$Natural_Increase), "\n")
```

## 趋势分析

```{r trend-analysis}
# 计算年度增长率
example_data <- example_data %>%
  arrange(Year) %>%
  mutate(
    Population_Growth_Rate = (Total_Population - lag(Total_Population)) / lag(Total_Population) * 100
  )

# 显示增长率
cat("年度人口增长率：\n")
print(example_data %>% 
      select(Year, Total_Population, Population_Growth_Rate) %>%
      filter(!is.na(Population_Growth_Rate)))
```

# 数据保存

```{r save-data}
# 保存清理后的数据
write_csv(example_data, "data/hk_population_cleaned.csv")
cat("数据已保存到 data/hk_population_cleaned.csv\n")

# 也可以保存为R数据格式
saveRDS(example_data, "data/hk_population_cleaned.rds")
```

# 挑战与限制

## 技术挑战

1.  **网站结构变化**：政府网站可能会更新，导致爬取代码失效
2.  **反爬虫机制**：某些网站可能有反爬虫保护，需要适当的请求头和延迟
3.  **数据格式多样**：数据可能以PDF、Excel、HTML表格等多种格式存在
4.  **数据更新频率**：需要定期更新数据以保持分析的最新性

## 伦理与法律考虑

1.  **遵守robots.txt**：在爬取前检查网站的robots.txt文件
2.  **合理使用**：避免过度请求，设置适当的延迟
3.  **数据使用**：确保数据使用符合网站的使用条款
4.  **隐私保护**：如果涉及个人数据，需要特别注意隐私保护

# 未来改进方向

1.  **自动化数据更新**：设置定期任务自动爬取最新数据
2.  **多数据源整合**：整合多个官方数据源以获得更全面的视角
3.  **预测模型**：基于历史数据建立人口预测模型
4.  **交互式可视化**：创建交互式仪表板展示数据
5.  **细分分析**：按年龄组、性别、地区等维度进行更细致的分析

# 结论

通过本项目的实施，我们：

1.  建立了从香港政府网站爬取人口数据的方法框架
2.  对数据进行清理和预处理，使其适合分析
3.  通过可视化展示了香港人口变化的多个维度
4.  识别了人口变化的主要趋势和模式

**重要提示**： - 本报告中的示例数据仅用于演示目的 -
实际使用时需要根据目标网站的具体结构调整爬取代码 -
建议在实际爬取前先手动访问目标网站，了解其结构和数据格式 -
确保遵守相关法律法规和网站使用条款

# 参考资料

-   香港政府统计处：<https://www.censtatd.gov.hk/>
-   香港入境事务处：<https://www.immd.gov.hk/>
-   R Markdown文档：<https://rmarkdown.rstudio.com/>
-   rvest包文档：<https://rvest.tidyverse.org/>

# 附录：完整代码示例

```{r appendix-code, eval=FALSE}
# 这是一个更完整的爬取函数示例
scrape_hk_population_data <- function(url) {
  # 设置请求参数
  headers <- c(
    'User-Agent' = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
    'Accept' = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
  )
  
  # 发送请求
  response <- GET(url, add_headers(.headers = headers), timeout(30))
  
  if (status_code(response) == 200) {
    # 解析HTML
    page <- read_html(response)
    
    # 提取表格（需要根据实际网站结构调整选择器）
    tables <- page %>% html_nodes("table")
    
    # 提取数据
    if (length(tables) > 0) {
      data <- tables[[1]] %>% html_table(fill = TRUE)
      return(data)
    }
  }
  
  return(NULL)
}

# 使用示例
# data <- scrape_hk_population_data("https://example.com/population")
```
