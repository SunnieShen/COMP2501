cat("Error downloading:", e$message, "\n")
})
}
}
}
}, error = function(e) {
cat("Error accessing Immigration Department:", e$message, "\n")
})
# 从政府新闻公报搜索人才计划相关数据
tryCatch({
# 搜索人才计划相关新闻
search_url <- "https://www.info.gov.hk/gia/general/"
response <- GET(search_url,
user_agent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"),
timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 查找包含统计数据的新闻链接
news_links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[!is.na(.)] %>%
.[grepl("talent|人才|statistic|统计", ., ignore.case = TRUE)]
if (length(news_links) > 0) {
cat("Found", length(news_links), "potential news articles with statistics\n")
# 访问前几个相关新闻页面
for (i in 1:min(3, length(news_links))) {
tryCatch({
news_url <- ifelse(grepl("^http", news_links[i]),
news_links[i],
paste0("https://www.info.gov.hk", news_links[i]))
news_response <- GET(news_url, timeout(30))
if (status_code(news_response) == 200) {
news_page <- read_html(news_response)
# 提取表格
news_tables <- news_page %>% html_nodes("table")
if (length(news_tables) > 0) {
for (j in 1:length(news_tables)) {
table_data <- news_tables[[j]] %>% html_table(fill = TRUE)
if (nrow(table_data) > 0) {
write_csv(table_data, paste0("data/news_table_", i, "_", j, ".csv"))
cat("Extracted table from news article", i, "\n")
}
}
}
}
}, error = function(e) {
cat("Error processing news article", i, ":", e$message, "\n")
})
}
}
}
}, error = function(e) {
cat("Error accessing government news:", e$message, "\n")
})
# 读取所有已下载的CSV文件
csv_files <- list.files("data", pattern = "\\.csv$", full.names = TRUE)
if (length(csv_files) > 0) {
cat("Found", length(csv_files), "CSV files\n")
# 读取并尝试识别人才相关数据
for (file in csv_files) {
tryCatch({
data <- read_csv(file, locale = locale(encoding = "UTF-8"), show_col_types = FALSE)
# 检查是否包含人才计划数据
col_names <- names(data)
data_text <- paste(as.character(data), collapse = " ")
# 识别人才引入数据
if (any(grepl("application|申请|approval|批准|scheme|计划", col_names, ignore.case = TRUE)) &&
any(grepl("year|年份|Year", col_names, ignore.case = TRUE))) {
if (is.null(talent_inflow)) {
talent_inflow <- data
cat("Loaded talent inflow data from:", basename(file), "\n")
}
}
# 识别人口/移民数据
if (any(grepl("population|人口|immigration|移民|emigration|移出", col_names, ignore.case = TRUE))) {
if (is.null(population_data)) {
population_data <- data
cat("Loaded population/migration data from:", basename(file), "\n")
}
}
}, error = function(e) {
cat("Error reading", basename(file), ":", e$message, "\n")
})
}
} else {
cat("No CSV files found. Please check data scraping sections above.\n")
}
# 清理人才引入数据
if (!is.null(talent_inflow)) {
cat("Cleaning talent inflow data...\n")
# 标准化列名
col_names <- names(talent_inflow)
col_names <- tolower(col_names)
col_names <- str_replace_all(col_names, "\\s+", "_")
names(talent_inflow) <- col_names
# 尝试识别年份列
year_col <- col_names[grepl("year|年份|年", col_names)][1]
if (!is.na(year_col)) {
talent_inflow <- talent_inflow %>%
rename(Year = !!sym(year_col))
}
# 尝试识别申请和批准列
app_col <- col_names[grepl("application|申请", col_names)][1]
appr_col <- col_names[grepl("approval|批准|approved", col_names)][1]
if (!is.na(app_col) && !is.na(appr_col)) {
talent_inflow <- talent_inflow %>%
rename(Applications = !!sym(app_col),
Approvals = !!sym(appr_col)) %>%
mutate(
Applications = as.numeric(str_replace_all(as.character(Applications), "[,，]|\\s", "")),
Approvals = as.numeric(str_replace_all(as.character(Approvals), "[,，]|\\s", "")),
Approval_Rate = ifelse(!is.na(Applications) & Applications > 0,
Approvals / Applications * 100, NA)
) %>%
filter(!is.na(Year) & !is.na(Applications))
cat("Talent inflow data cleaned. Rows:", nrow(talent_inflow), "\n")
}
} else {
cat("Warning: No talent inflow data found. Creating empty structure.\n")
talent_inflow <- data.frame(
Year = integer(),
Scheme = character(),
Applications = numeric(),
Approvals = numeric(),
Approval_Rate = numeric(),
stringsAsFactors = FALSE
)
}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
fig.width = 10, fig.height = 6)
# 网络爬取相关包
library(rvest)      # 用于HTML解析和网页爬取
library(httr)       # 用于HTTP请求
library(xml2)       # XML/HTML处理
# 数据处理相关包
library(tidyverse)  # 数据整理和可视化
library(dplyr)      # 数据操作
library(readr)      # 数据读取
library(lubridate)  # 日期处理
# 可视化相关包
library(ggplot2)    # 数据可视化
library(scales)     # 图表格式化（如数字格式化）
# 其他工具包
library(stringr)    # 字符串处理
library(jsonlite)   # JSON数据处理（如果数据是JSON格式）
# 定义目标URL（香港政府统计处人口统计页面）
# 注意：实际URL需要根据网站结构调整
census_url <- "https://www.censtatd.gov.hk/tc/scode150.html"
# 尝试访问网页
tryCatch({
# 设置用户代理，模拟浏览器访问
user_agent <- "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
# 发送GET请求
response <- GET(census_url,
user_agent(user_agent),
timeout(30))
# 检查响应状态
if (status_code(response) == 200) {
cat("Successfully connected to website\n")
# 解析HTML内容
page_content <- read_html(response)
# 提取所有表格
tables <- page_content %>% html_nodes("table")
cat("Found", length(tables), "tables\n")
# 提取所有链接（可能包含数据下载链接）
links <- page_content %>%
html_nodes("a") %>%
html_attr("href")
# 过滤出可能包含数据的链接（如PDF、Excel、CSV文件）
data_links <- links[grepl("\\.(pdf|xlsx|csv|xls)$", links, ignore.case = TRUE)]
cat("Found", length(data_links), "possible data file links\n")
} else {
cat("Unable to access website, status code:", status_code(response), "\n")
}
}, error = function(e) {
cat("Error occurred during scraping:", e$message, "\n")
})
# 入境事务处人才计划相关URL
immigration_url <- "https://www.immd.gov.hk/"
talent_schemes_url <- "https://www.immd.gov.hk/hkt/services/index.html"
tryCatch({
# 设置请求头
headers <- c(
'User-Agent' = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
'Accept' = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
'Accept-Language' = 'zh-CN,zh;q=0.9,en;q=0.8'
)
# 发送请求
response <- GET(talent_schemes_url,
add_headers(.headers = headers),
timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 查找包含人才计划统计数据的链接
# 关键词包括：人才、talent、优才、专才、高端人才通行证等
talent_keywords <- "talent|优才|专才|人才|QMAS|GEP|ASMTP|TechTAS|高端人才通行证"
stat_links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[grepl(talent_keywords, ., ignore.case = TRUE)]
cat("Found", length(stat_links), "possible talent scheme related links\n")
print(head(stat_links, 10))
# 查找统计数据页面
stat_page_links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[grepl("statistic|stat|data|统计", ., ignore.case = TRUE)]
cat("Found", length(stat_page_links), "possible statistics page links\n")
}
}, error = function(e) {
cat("Error:", e$message, "\n")
})
# 政府新闻公报中可能包含人才计划的申请和批准数据
gov_news_url <- "https://www.info.gov.hk/gia/general/"
# 搜索包含人才计划相关关键词的新闻
talent_search_terms <- c("人才计划", "talent scheme", "优才", "专才",
"高端人才通行证", "Top Talent Pass Scheme")
# 注意：实际爬取时需要根据网站结构调整选择器
# 这里提供一个框架用于搜索相关新闻公报
# 示例：搜索包含"人才"关键词的新闻
tryCatch({
# 注意：实际URL可能需要通过搜索功能获取
# 这里仅提供框架
cat("Note: Need to visit government news website to search for talent scheme related news\n")
cat("Possible search URL format:\n")
cat("https://www.info.gov.hk/gia/general/search.htm?query=talent\n")
}, error = function(e) {
cat("Error:", e$message, "\n")
})
# 政府统计处劳动力市场数据
labour_url <- "https://www.censtatd.gov.hk/tc/scode200.html"
tryCatch({
response <- GET(labour_url,
user_agent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"),
timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 查找包含行业分布、就业统计的链接
labour_links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[grepl("employment|labour|industry|就业|劳动力|行业", ., ignore.case = TRUE)]
cat("Found", length(labour_links), "possible labour market data links\n")
}
}, error = function(e) {
cat("Error:", e$message, "\n")
})
# 如果网站提供直接下载链接，可以使用download.file()
# 示例：下载CSV或Excel文件
# 创建数据存储目录
if (!dir.exists("data")) {
dir.create("data")
}
# 示例：如果有直接的数据下载链接
# download_url <- "https://example.com/population_data.csv"
# download.file(download_url, destfile = "data/population_data.csv", mode = "wb")
# 创建数据存储目录
if (!dir.exists("data")) {
dir.create("data")
}
# 初始化数据框
talent_inflow <- NULL
talent_outflow <- NULL
population_data <- NULL
# 尝试从政府统计处提取数据
tryCatch({
census_url <- "https://www.censtatd.gov.hk/tc/scode150.html"
response <- GET(census_url,
user_agent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"),
timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 提取所有表格
tables <- page %>% html_nodes("table")
cat("Found", length(tables), "tables from Census Department\n")
# 尝试提取第一个表格作为示例
if (length(tables) > 0) {
# 提取表格数据
for (i in 1:min(3, length(tables))) {
tryCatch({
table_data <- tables[[i]] %>% html_table(fill = TRUE)
if (nrow(table_data) > 0 && ncol(table_data) > 0) {
cat("Table", i, "dimensions:", nrow(table_data), "x", ncol(table_data), "\n")
# 保存原始表格数据
write_csv(table_data, paste0("data/census_table_", i, ".csv"))
}
}, error = function(e) {
cat("Error extracting table", i, ":", e$message, "\n")
})
}
}
# 查找并下载数据文件
links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[!is.na(.)]
# 处理相对链接
base_url <- "https://www.censtatd.gov.hk"
data_links <- links[grepl("\\.(pdf|xlsx|csv|xls)$", links, ignore.case = TRUE)]
if (length(data_links) > 0) {
cat("Found", length(data_links), "data file links\n")
# 下载前几个数据文件（可根据需要调整）
for (i in 1:min(3, length(data_links))) {
tryCatch({
file_url <- ifelse(grepl("^http", data_links[i]),
data_links[i],
paste0(base_url, data_links[i]))
file_ext <- tools::file_ext(data_links[i])
file_name <- paste0("data/census_data_", i, ".", file_ext)
download.file(file_url, destfile = file_name, mode = "wb", quiet = TRUE)
cat("Downloaded:", file_name, "\n")
}, error = function(e) {
cat("Error downloading file", i, ":", e$message, "\n")
})
}
}
}
}, error = function(e) {
cat("Error accessing Census Department:", e$message, "\n")
})
# 从入境事务处提取人才计划统计数据
tryCatch({
# 入境事务处统计页面
stats_url <- "https://www.immd.gov.hk/hkt/statistics/index.html"
headers <- c(
'User-Agent' = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
'Accept' = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
)
response <- GET(stats_url, add_headers(.headers = headers), timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 提取表格
tables <- page %>% html_nodes("table")
cat("Found", length(tables), "tables from Immigration Department\n")
# 提取人才计划相关表格
if (length(tables) > 0) {
for (i in 1:min(5, length(tables))) {
tryCatch({
table_data <- tables[[i]] %>% html_table(fill = TRUE)
if (nrow(table_data) > 0 && ncol(table_data) > 0) {
# 检查表格是否包含人才计划相关信息
table_text <- paste(as.character(table_data), collapse = " ")
if (grepl("talent|人才|QMAS|GEP|ASMTP|TechTAS|优才|专才", table_text, ignore.case = TRUE)) {
cat("Found talent-related table", i, "\n")
write_csv(table_data, paste0("data/immigration_talent_table_", i, ".csv"))
# 尝试解析为结构化数据
# 这里需要根据实际表格结构调整
if (is.null(talent_inflow)) {
# 尝试识别列名
col_names <- names(table_data)
if (any(grepl("year|年份|Year", col_names, ignore.case = TRUE)) &&
any(grepl("application|申请|approval|批准", col_names, ignore.case = TRUE))) {
talent_inflow <- table_data
cat("Identified talent inflow data structure\n")
}
}
}
}
}, error = function(e) {
cat("Error processing table", i, ":", e$message, "\n")
})
}
}
# 查找数据文件链接
links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[!is.na(.)]
base_url <- "https://www.immd.gov.hk"
data_links <- links[grepl("\\.(pdf|xlsx|csv|xls)$", links, ignore.case = TRUE)]
if (length(data_links) > 0) {
cat("Found", length(data_links), "data files from Immigration Department\n")
for (i in 1:min(5, length(data_links))) {
tryCatch({
file_url <- ifelse(grepl("^http", data_links[i]),
data_links[i],
paste0(base_url, data_links[i]))
file_ext <- tools::file_ext(data_links[i])
file_name <- paste0("data/immigration_data_", i, ".", file_ext)
download.file(file_url, destfile = file_name, mode = "wb", quiet = TRUE)
cat("Downloaded:", file_name, "\n")
}, error = function(e) {
cat("Error downloading:", e$message, "\n")
})
}
}
}
}, error = function(e) {
cat("Error accessing Immigration Department:", e$message, "\n")
})
# 从政府新闻公报搜索人才计划相关数据
tryCatch({
# 搜索人才计划相关新闻
search_url <- "https://www.info.gov.hk/gia/general/"
response <- GET(search_url,
user_agent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"),
timeout(30))
if (status_code(response) == 200) {
page <- read_html(response)
# 查找包含统计数据的新闻链接
news_links <- page %>%
html_nodes("a") %>%
html_attr("href") %>%
.[!is.na(.)] %>%
.[grepl("talent|人才|statistic|统计", ., ignore.case = TRUE)]
if (length(news_links) > 0) {
cat("Found", length(news_links), "potential news articles with statistics\n")
# 访问前几个相关新闻页面
for (i in 1:min(3, length(news_links))) {
tryCatch({
news_url <- ifelse(grepl("^http", news_links[i]),
news_links[i],
paste0("https://www.info.gov.hk", news_links[i]))
news_response <- GET(news_url, timeout(30))
if (status_code(news_response) == 200) {
news_page <- read_html(news_response)
# 提取表格
news_tables <- news_page %>% html_nodes("table")
if (length(news_tables) > 0) {
for (j in 1:length(news_tables)) {
table_data <- news_tables[[j]] %>% html_table(fill = TRUE)
if (nrow(table_data) > 0) {
write_csv(table_data, paste0("data/news_table_", i, "_", j, ".csv"))
cat("Extracted table from news article", i, "\n")
}
}
}
}
}, error = function(e) {
cat("Error processing news article", i, ":", e$message, "\n")
})
}
}
}
}, error = function(e) {
cat("Error accessing government news:", e$message, "\n")
})
# 读取所有已下载的CSV文件
csv_files <- list.files("data", pattern = "\\.csv$", full.names = TRUE)
if (length(csv_files) > 0) {
cat("Found", length(csv_files), "CSV files\n")
# 读取并尝试识别人才相关数据
for (file in csv_files) {
tryCatch({
data <- read_csv(file, locale = locale(encoding = "UTF-8"), show_col_types = FALSE)
# 检查是否包含人才计划数据
col_names <- names(data)
data_text <- paste(as.character(data), collapse = " ")
# 识别人才引入数据
if (any(grepl("application|申请|approval|批准|scheme|计划", col_names, ignore.case = TRUE)) &&
any(grepl("year|年份|Year", col_names, ignore.case = TRUE))) {
if (is.null(talent_inflow)) {
talent_inflow <- data
cat("Loaded talent inflow data from:", basename(file), "\n")
}
}
# 识别人口/移民数据
if (any(grepl("population|人口|immigration|移民|emigration|移出", col_names, ignore.case = TRUE))) {
if (is.null(population_data)) {
population_data <- data
cat("Loaded population/migration data from:", basename(file), "\n")
}
}
}, error = function(e) {
cat("Error reading", basename(file), ":", e$message, "\n")
})
}
} else {
cat("No CSV files found. Please check data scraping sections above.\n")
}
# 清理人才引入数据
if (!is.null(talent_inflow)) {
cat("Cleaning talent inflow data...\n")
# 标准化列名
col_names <- names(talent_inflow)
col_names <- tolower(col_names)
col_names <- str_replace_all(col_names, "\\s+", "_")
names(talent_inflow) <- col_names
# 尝试识别年份列
year_col <- col_names[grepl("year|年份|年", col_names)][1]
if (!is.na(year_col)) {
talent_inflow <- talent_inflow %>%
rename(Year = !!sym(year_col))
}
# 尝试识别申请和批准列
app_col <- col_names[grepl("application|申请", col_names)][1]
appr_col <- col_names[grepl("approval|批准|approved", col_names)][1]
if (!is.na(app_col) && !is.na(appr_col)) {
talent_inflow <- talent_inflow %>%
rename(Applications = !!sym(app_col),
Approvals = !!sym(appr_col)) %>%
mutate(
Applications = as.numeric(str_replace_all(as.character(Applications), "[,，]|\\s", "")),
Approvals = as.numeric(str_replace_all(as.character(Approvals), "[,，]|\\s", "")),
Approval_Rate = ifelse(!is.na(Applications) & Applications > 0,
Approvals / Applications * 100, NA)
) %>%
filter(!is.na(Year) & !is.na(Applications))
cat("Talent inflow data cleaned. Rows:", nrow(talent_inflow), "\n")
}
} else {
cat("Warning: No talent inflow data found. Creating empty structure.\n")
talent_inflow <- data.frame(
Year = integer(),
Scheme = character(),
Applications = numeric(),
Approvals = numeric(),
Approval_Rate = numeric(),
stringsAsFactors = FALSE
)
}
